<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Portal ‚Äî ProofPilot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --blue-600: #0051FF;
      --blue-500: #2563EB;
      --blue-100: #DBEAFE;
      --blue-50:  #EFF6FF;
      --green-600: #059669;
      --green-100: #D1FAE5;
      --green-50:  #ECFDF5;
      --red-600:   #DC2626;
      --red-100:   #FEE2E2;
      --amber-600: #D97706;
      --amber-100: #FEF3C7;
      --gray-900: #111827;
      --gray-800: #1F2937;
      --gray-700: #374151;
      --gray-600: #4B5563;
      --gray-500: #6B7280;
      --gray-400: #9CA3AF;
      --gray-300: #D1D5DB;
      --gray-200: #E5E7EB;
      --gray-100: #F3F4F6;
      --gray-50:  #F7F8FA;
      --white: #FFFFFF;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.03);
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.07);
      --radius: 8px;
      --radius-lg: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .portal-header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .portal-header-inner {
      max-width: 1080px;
      margin: 0 auto;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .portal-logo {
      font-weight: 800;
      font-size: 18px;
      letter-spacing: -0.02em;
      color: var(--blue-600);
    }
    .portal-logo span { color: var(--gray-900); }
    .header-divider {
      width: 1px;
      height: 24px;
      background: var(--gray-300);
    }
    .header-client {
      font-weight: 600;
      font-size: 15px;
      color: var(--gray-700);
    }
    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-plan {
      background: var(--blue-100);
      color: var(--blue-600);
    }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    .portal-body {
      max-width: 1080px;
      margin: 0 auto;
      padding: 28px 24px 80px;
    }

    /* ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 28px;
    }
    .kpi-card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }
    .kpi-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      margin-bottom: 6px;
    }
    .kpi-value {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--gray-900);
      line-height: 1.2;
    }
    .kpi-sub {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }
    .kpi-loading {
      color: var(--gray-400);
      font-size: 13px;
      font-style: italic;
    }

    /* KPI accent colors */
    .kpi-card.accent-blue { border-top: 3px solid var(--blue-600); }
    .kpi-card.accent-green { border-top: 3px solid var(--green-600); }
    .kpi-card.accent-amber { border-top: 3px solid var(--amber-600); }

    /* ‚îÄ‚îÄ Score Bar ‚îÄ‚îÄ */
    .score-section {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 28px;
      box-shadow: var(--shadow-sm);
    }
    .score-section h3 {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 16px;
    }
    .score-bars {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .score-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .score-label {
      width: 120px;
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-600);
      flex-shrink: 0;
    }
    .score-bar-bg {
      flex: 1;
      height: 8px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
    }
    .score-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.6s ease;
    }
    .score-val {
      width: 40px;
      font-size: 13px;
      font-weight: 700;
      text-align: right;
      color: var(--gray-700);
    }

    /* ‚îÄ‚îÄ Section Cards ‚îÄ‚îÄ */
    .section-card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    .section-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .section-header h3 {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-800);
    }
    .section-count {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-500);
      background: var(--gray-100);
      padding: 2px 10px;
      border-radius: 12px;
    }

    /* ‚îÄ‚îÄ Filter Tabs ‚îÄ‚îÄ */
    .filter-row {
      display: flex;
      gap: 6px;
      padding: 12px 24px;
      border-bottom: 1px solid var(--gray-100);
      background: var(--gray-50);
    }
    .filter-btn {
      padding: 5px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--gray-200);
      background: var(--white);
      color: var(--gray-600);
      transition: all 0.15s ease;
    }
    .filter-btn:hover {
      border-color: var(--blue-500);
      color: var(--blue-600);
    }
    .filter-btn.active {
      background: var(--blue-600);
      border-color: var(--blue-600);
      color: var(--white);
    }

    /* ‚îÄ‚îÄ Content Items ‚îÄ‚îÄ */
    .content-list { padding: 0; }
    .content-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 24px;
      border-bottom: 1px solid var(--gray-100);
      transition: background 0.1s ease;
    }
    .content-item:last-child { border-bottom: none; }
    .content-item:hover { background: var(--gray-50); }
    .ci-icon {
      width: 36px; height: 36px;
      border-radius: var(--radius);
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .ci-icon.report { background: var(--blue-50); }
    .ci-icon.content { background: var(--green-50); }
    .ci-body { flex: 1; min-width: 0; }
    .ci-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .ci-date {
      font-size: 12px;
      color: var(--gray-400);
    }
    .badge-approved {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      background: var(--green-100);
      color: var(--green-600);
    }
    .ci-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .btn {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--gray-300);
      background: var(--white);
      color: var(--gray-600);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s ease;
    }
    .btn:hover {
      border-color: var(--blue-500);
      color: var(--blue-600);
    }
    .btn-primary {
      background: var(--blue-600);
      border-color: var(--blue-600);
      color: var(--white);
    }
    .btn-primary:hover { background: var(--blue-500); }

    /* ‚îÄ‚îÄ Empty / Loading / Error ‚îÄ‚îÄ */
    .portal-loading {
      text-align: center;
      padding: 120px 24px;
      color: var(--gray-400);
    }
    .loading-spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--blue-600);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--gray-400);
    }
    .empty-state-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 4px;
    }
    .portal-error {
      text-align: center;
      padding: 120px 24px;
    }
    .portal-error-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--gray-700);
      margin-bottom: 6px;
    }
    .portal-error-msg { color: var(--gray-500); font-size: 14px; }

    /* ‚îÄ‚îÄ Preview Modal ‚îÄ‚îÄ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(4px);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 760px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-header h3 { font-size: 16px; font-weight: 700; }
    .modal-close {
      background: none; border: none;
      color: var(--gray-400);
      font-size: 22px;
      cursor: pointer;
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 6px;
    }
    .modal-close:hover { background: var(--gray-100); color: var(--gray-600); }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
      color: var(--gray-700);
    }

    /* ‚îÄ‚îÄ Skeleton Loading ‚îÄ‚îÄ */
    .skeleton {
      background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 6px;
      display: inline-block;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-kpi { width: 80px; height: 32px; }
    .skeleton-text { width: 120px; height: 14px; }

    /* ‚îÄ‚îÄ Left accent borders on content items ‚îÄ‚îÄ */
    .content-item { border-left: 3px solid transparent; }
    .content-item[data-type="report"] { border-left-color: var(--blue-600); }
    .content-item[data-type="content"] { border-left-color: var(--green-600); }
    .content-item[data-type="gbp"] { border-left-color: var(--amber-600); }

    /* ‚îÄ‚îÄ Stagger fade-in ‚îÄ‚îÄ */
    .content-item {
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.35s ease forwards;
    }
    @keyframes fadeUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* ‚îÄ‚îÄ Sparkline container ‚îÄ‚îÄ */
    .kpi-sparkline {
      margin-top: 8px;
      height: 28px;
      opacity: 0.7;
    }
    .kpi-sparkline svg { width: 100%; height: 28px; }

    /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
    .portal-footer {
      text-align: center;
      padding: 32px;
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 48px;
    }
    .portal-footer-brand {
      font-weight: 700;
      color: #00184D;
      text-decoration: none;
    }
    .portal-footer-tag {
      display: block;
      font-size: 11px;
      color: var(--gray-400);
      margin-top: 4px;
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .kpi-value { font-size: 22px; }
    }
    @media (max-width: 640px) {
      .kpi-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
      .kpi-card { padding: 14px; }
      .kpi-value { font-size: 20px; }
      .content-item { flex-direction: column; align-items: flex-start; gap: 10px; }
      .ci-actions { width: 100%; }
      .portal-header-inner { gap: 10px; }
      .header-client { font-size: 13px; }
    }
  </style>
</head>
<body>

  <header class="portal-header">
    <div class="portal-header-inner">
      <div class="portal-logo">PROOF<span>PILOT</span></div>
      <div class="header-divider"></div>
      <div class="header-client" id="headerClientName">Client Portal</div>
      <div class="header-right">
        <span class="header-badge badge-plan" id="headerPlan" style="display:none"></span>
      </div>
    </div>
  </header>

  <main class="portal-body" id="portalBody">
    <div class="portal-loading" id="portalLoading">
      <div class="loading-spinner"></div>
      <div>Loading your portal...</div>
    </div>
  </main>

  <!-- Preview modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">Document Preview</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const REPORT_IDS = ['website-seo-audit','prospect-audit','keyword-gap','monthly-report'];
    const CONTENT_IDS = ['seo-blog-post','service-page','location-page','home-service-content','gbp-posts','programmatic-content'];
    const WF_ICONS = {
      'website-seo-audit': 'üîç', 'prospect-audit': 'üéØ', 'keyword-gap': 'üìä',
      'seo-blog-post': '‚úçÔ∏è', 'service-page': '‚ö°', 'location-page': 'üìç',
      'home-service-content': 'üè†', 'programmatic-content': 'üîÑ',
      'gbp-posts': 'üì±', 'monthly-report': 'üìà',
    };

    let portalData = null;
    let metricsData = null;
    let activeFilter = 'all';

    function getToken() {
      const parts = window.location.pathname.split('/');
      return parts[parts.length - 1] || '';
    }

    async function loadPortal() {
      const token = getToken();
      if (!token) return showError('No portal token provided.');

      try {
        const res = await fetch('/api/portal/' + token);
        if (!res.ok) {
          if (res.status === 404) return showError('This portal link is not valid or has been deactivated.');
          return showError('Failed to load portal data.');
        }
        portalData = await res.json();
        renderPortal();

        // Load live SEO metrics async (doesn't block initial render)
        loadMetrics(token);
      } catch (e) {
        showError('Unable to connect. Please try again later.');
      }
    }

    async function loadMetrics(token) {
      try {
        const res = await fetch('/api/portal/' + token + '/metrics');
        if (!res.ok) return;
        const data = await res.json();
        if (data.metrics) {
          metricsData = data.metrics;
          updateKPICards();
          if (metricsData.pillar_scores_raw) parsePillarScores(metricsData.pillar_scores_raw);
        }
      } catch (e) {
        // Metrics are optional ‚Äî portal still works without them
      }
    }

    function showError(msg) {
      document.getElementById('portalBody').innerHTML = `
        <div class="portal-error">
          <div style="font-size:40px;margin-bottom:12px;">üîí</div>
          <div class="portal-error-title">Portal Unavailable</div>
          <div class="portal-error-msg">${msg}</div>
        </div>`;
    }

    function fmtNum(n) {
      if (n == null || isNaN(n)) return '‚Äî';
      return n.toLocaleString();
    }
    function fmtDollar(n) {
      if (n == null || isNaN(n)) return '‚Äî';
      return '$' + n.toLocaleString();
    }

    // Count-up animation for KPI numbers
    function animateValue(el, end, prefix, suffix, duration) {
      duration = duration || 800;
      prefix = prefix || '';
      suffix = suffix || '';
      let start = 0;
      const step = (ts) => {
        if (!start) start = ts;
        const progress = Math.min((ts - start) / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        el.textContent = prefix + Math.floor(eased * end).toLocaleString() + suffix;
        if (progress < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    // SVG sparkline generator
    function sparklineSVG(data, color) {
      color = color || '#0051FF';
      if (!data || data.length < 2) return '';
      const w = 100, h = 28;
      const max = Math.max(...data), min = Math.min(...data);
      const range = max - min || 1;
      const pts = data.map((v, i) => {
        const x = (i / (data.length - 1)) * w;
        const y = h - ((v - min) / range) * (h - 4) - 2;
        return x + ',' + y;
      }).join(' ');
      return '<svg viewBox="0 0 ' + w + ' ' + h + '"><polyline points="' + pts + '" fill="none" stroke="' + color + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    }

    function renderPortal() {
      const c = portalData.client;
      document.getElementById('headerClientName').textContent = c.name;
      document.title = c.name + ' ‚Äî ProofPilot Portal';

      if (c.plan) {
        const badge = document.getElementById('headerPlan');
        badge.textContent = c.plan;
        badge.style.display = '';
      }

      const total = portalData.items.length;
      const approvedCount = portalData.items.filter(i => i.approved).length;
      const reportsCount = portalData.items.filter(i => REPORT_IDS.includes(i.workflow_id)).length;
      const contentCount = portalData.items.filter(i => CONTENT_IDS.includes(i.workflow_id)).length;

      let html = '';

      // ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ
      html += `
        <div class="kpi-grid">
          <div class="kpi-card accent-blue" id="kpiKeywords">
            <div class="kpi-label">Ranked Keywords</div>
            <div class="kpi-value" id="kpiKeywordsVal"><span class="skeleton skeleton-kpi"></span></div>
            <div class="kpi-sub">Keywords ranking in Google</div>
          </div>
          <div class="kpi-card accent-blue" id="kpiTraffic">
            <div class="kpi-label">Monthly Traffic</div>
            <div class="kpi-value" id="kpiTrafficVal"><span class="skeleton skeleton-kpi"></span></div>
            <div class="kpi-sub">Estimated organic visits/mo</div>
          </div>
          <div class="kpi-card accent-green" id="kpiValue">
            <div class="kpi-label">Traffic Value</div>
            <div class="kpi-value" id="kpiValueVal"><span class="skeleton skeleton-kpi"></span></div>
            <div class="kpi-sub">Equivalent PPC spend/mo</div>
          </div>
          <div class="kpi-card accent-amber" id="kpiDeliverables">
            <div class="kpi-label">Deliverables</div>
            <div class="kpi-value" id="kpiDeliverablesVal">${total}</div>
            <div class="kpi-sub">${approvedCount} approved</div>
          </div>
        </div>`;

      // ‚îÄ‚îÄ SEO Score Section (placeholder ‚Äî filled by metrics) ‚îÄ‚îÄ
      html += `<div class="score-section" id="scoreSection" style="display:none">
        <h3>SEO Health Scorecard</h3>
        <div class="score-bars" id="scoreBars"></div>
      </div>`;

      // ‚îÄ‚îÄ Client Info Bar ‚îÄ‚îÄ
      const meta = [c.domain, c.service, c.location].filter(Boolean);
      if (meta.length) {
        html += `<div style="display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap;">
          ${meta.map(m => `<span style="font-size:13px;color:var(--gray-500);">${m}</span>`).join('<span style="color:var(--gray-300);">¬∑</span>')}
        </div>`;
      }

      // ‚îÄ‚îÄ Content Section ‚îÄ‚îÄ
      html += `<div class="section-card">
        <div class="section-header">
          <h3>Your Documents</h3>
          <span class="section-count">${total} total</span>
        </div>
        <div class="filter-row">
          <button class="filter-btn ${activeFilter==='all'?'active':''}" onclick="setFilter('all')">All (${total})</button>
          <button class="filter-btn ${activeFilter==='reports'?'active':''}" onclick="setFilter('reports')">Reports (${reportsCount})</button>
          <button class="filter-btn ${activeFilter==='content'?'active':''}" onclick="setFilter('content')">Content (${contentCount})</button>
          <button class="filter-btn ${activeFilter==='approved'?'active':''}" onclick="setFilter('approved')">Approved (${approvedCount})</button>
        </div>`;

      let items = portalData.items;
      if (activeFilter === 'approved') items = items.filter(i => i.approved);
      if (activeFilter === 'reports') items = items.filter(i => REPORT_IDS.includes(i.workflow_id));
      if (activeFilter === 'content') items = items.filter(i => CONTENT_IDS.includes(i.workflow_id));

      if (!items.length) {
        html += `<div class="empty-state">
          <div class="empty-state-title">No documents yet</div>
          <div>Content and reports will appear here as they're created.</div>
        </div>`;
      } else {
        html += '<div class="content-list">';
        items.forEach((item, idx) => {
          const icon = WF_ICONS[item.workflow_id] || 'üìÑ';
          const isReport = REPORT_IDS.includes(item.workflow_id);
          const isGBP = item.workflow_id === 'gbp-posts';
          const iconClass = isReport ? 'report' : 'content';
          const dataType = isReport ? 'report' : isGBP ? 'gbp' : 'content';
          const delay = Math.min(idx * 50, 500);
          const approved = item.approved ? '<span class="badge-approved">Approved</span>' : '';
          const dlBtn = item.has_docx
            ? `<a class="btn btn-primary" href="/api/download/${item.job_id}" target="_blank">Download</a>`
            : '';
          const previewBtn = `<button class="btn" onclick="showPreview('${item.job_id}')">Preview</button>`;

          html += `<div class="content-item" data-type="${dataType}" style="animation-delay:${delay}ms">
            <div class="ci-icon ${iconClass}">${icon}</div>
            <div class="ci-body">
              <div class="ci-title">${item.workflow_title}</div>
              <div class="ci-date">${item.created_at}</div>
            </div>
            ${approved}
            <div class="ci-actions">${previewBtn}${dlBtn}</div>
          </div>`;
        });
        html += '</div>';
      }
      html += '</div>'; // close section-card

      html += `<div class="portal-footer">
        Powered by <a class="portal-footer-brand" href="https://proofpilot.com">PROOFPILOT</a>
        <span class="portal-footer-tag">AI-Powered SEO Operations</span>
      </div>`;

      document.getElementById('portalBody').innerHTML = html;
    }

    function updateKPICards() {
      if (!metricsData) return;
      const kw = document.getElementById('kpiKeywordsVal');
      const tr = document.getElementById('kpiTrafficVal');
      const tv = document.getElementById('kpiValueVal');
      const noData = '<span style="color:var(--gray-400);font-size:14px;">‚Äî</span>';

      if (kw && metricsData.keywords != null && metricsData.keywords > 0) {
        kw.textContent = '0';
        animateValue(kw, metricsData.keywords, '', '', 900);
      } else if (kw) { kw.innerHTML = noData; }

      if (tr && metricsData.traffic != null && metricsData.traffic > 0) {
        tr.textContent = '0';
        animateValue(tr, metricsData.traffic, '', '', 900);
      } else if (tr) { tr.innerHTML = noData; }

      if (tv && metricsData.traffic_value != null && metricsData.traffic_value > 0) {
        tv.textContent = '$0';
        animateValue(tv, metricsData.traffic_value, '$', '/mo', 900);
      } else if (tv) { tv.innerHTML = noData; }

      // Animate deliverables count too
      const dv = document.getElementById('kpiDeliverablesVal');
      if (dv && portalData && portalData.items.length > 0) {
        const count = portalData.items.length;
        dv.textContent = '0';
        animateValue(dv, count, '', '', 600);
      }
    }

    function parsePillarScores(raw) {
      // Try to extract scores from SA pillar scores text
      const section = document.getElementById('scoreSection');
      const bars = document.getElementById('scoreBars');
      if (!section || !bars) return;

      const pillars = [];
      const patterns = [
        { re: /on.?page[^:]*:\s*(\d+)/i, label: 'On-Page SEO' },
        { re: /technical[^:]*:\s*(\d+)/i, label: 'Technical' },
        { re: /backlink[^:]*:\s*(\d+)/i, label: 'Backlinks' },
        { re: /content[^:]*:\s*(\d+)/i, label: 'Content' },
        { re: /local[^:]*:\s*(\d+)/i, label: 'Local SEO' },
        { re: /overall[^:]*:\s*(\d+)/i, label: 'Overall' },
      ];

      patterns.forEach(p => {
        const m = raw.match(p.re);
        if (m) pillars.push({ label: p.label, score: parseInt(m[1]) });
      });

      // Fallback: try to parse "Category: XX" or "Category XX/100" patterns
      if (!pillars.length) {
        const lines = raw.split('\n');
        lines.forEach(line => {
          const m = line.match(/([A-Za-z\s]+?)[\s:]+(\d{1,3})(?:\s*\/\s*100)?/);
          if (m && parseInt(m[2]) <= 100) {
            const label = m[1].trim();
            if (label.length > 2 && label.length < 30) {
              pillars.push({ label, score: parseInt(m[2]) });
            }
          }
        });
      }

      if (!pillars.length) return;

      section.style.display = '';
      bars.innerHTML = pillars.map(p => {
        const color = p.score >= 70 ? 'var(--green-600)' : p.score >= 40 ? 'var(--amber-600)' : 'var(--red-600)';
        return `<div class="score-row">
          <span class="score-label">${p.label}</span>
          <div class="score-bar-bg">
            <div class="score-bar-fill" style="width:${p.score}%;background:${color}"></div>
          </div>
          <span class="score-val">${p.score}</span>
        </div>`;
      }).join('');
    }

    function setFilter(f) {
      activeFilter = f;
      renderPortal();
      // Re-apply metrics after re-render
      if (metricsData) {
        updateKPICards();
        if (metricsData.pillar_scores_raw) parsePillarScores(metricsData.pillar_scores_raw);
      }
    }

    async function showPreview(jobId) {
      const item = portalData.items.find(i => i.job_id === jobId);
      if (!item) return;

      document.getElementById('modalTitle').textContent = item.workflow_title;
      document.getElementById('modalBody').textContent = 'Loading...';
      document.getElementById('modalOverlay').classList.add('open');

      try {
        const res = await fetch('/api/jobs/' + jobId);
        if (!res.ok) throw new Error();
        const data = await res.json();
        document.getElementById('modalBody').textContent = data.content || data.content_preview || 'No content available.';
      } catch (e) {
        document.getElementById('modalBody').textContent = item.preview || 'Preview unavailable.';
      }
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('open');
    }

    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    // Boot
    loadPortal();
  </script>
</body>
</html>
